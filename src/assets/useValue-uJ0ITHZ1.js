import{c as k}from"./index-DsTk74qP.js";import{u as B}from"./util-CASLgOZv.js";import{s as R,r as D,t as I,k as P,j as A,$ as J}from"./index-Dju9e0Mk.js";import{s as _}from"./system-BzlGO5Bl.js";import{u as W}from"./useObserverMsg-mppqzyYd.js";import{c as L}from"./categorizeParameters-C40L_2hr.js";function z(t,x){let y;return function(...w){clearTimeout(y),y=setTimeout(()=>{t(...w)},x)}}function O(t){window.setDBItem("cacheWatchTabs",JSON.parse(JSON.stringify(t)))}function E(t={}){return{name:"",tableData:[],isMain:!1,tableExtendedData:{writeValue:{},readValue:{},displayType:{},TimeRefresh:{}},...t}}function Q(t,x,y){const{appContext:w}=R(),{$message:d}=w.config.globalProperties,l=D([t.value]);I(()=>{var e;return(e=t.value)==null?void 0:e.tableExtendedData},z(()=>O(l.value),2e3),{deep:!0});const M=D();function b(e){const a=E(e);l.value.push(a),v(a),m(),O(l.value)}function N(e){var o;(o=e.win)==null||o.close();const a=l.value.indexOf(e);l.value.splice(a,1),e.name===t.value.name&&(t.value=l.value[0]),O(l.value)}const g=D("260px"),n=P(()=>t.value.isMain),h=P({get:()=>n.value?g.value:0,set(e){g.value=e}});let i=null;function v(e){if(e.name!==t.value.name){if(x(e.tableData||[]),e.isMain||t.value.isMain){let a=null;i?a=i:a=i=document.querySelector(".arco-split-pane-first");let o=null;e.isMain?o={flex:["0 0 calc(0)",`0 0 calc(${g.value})`]}:o={flex:[`0 0 calc(${g.value})`,"0 0 calc(0)"]};const s=a.animate(o,{duration:300,fill:"forwards",easing:"ease"});s.onfinish=s.cancel}t.value=e}}const c=A({value:!1,percentage:0,showProgress:!1,description:"",progressText:""}),f=D([]),r={};async function u(e){if(!e)return J.prompt("请输入窗口名称","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info",beforeClose:(s,{inputValue:T},j)=>{if(s==="cancel")return j();if(!(T||"").trim())return d.error("不能为空");if(l.value.some($=>$.name===T))return d.error("不能重复");j()}}).then(({value:s})=>u({tabName:s})).catch(()=>{});const a=f.value.length;Object.assign(c,{value:!0,showProgress:!0,percentage:0,progressText:`0/${a}`,description:"正在添加到窗口"});const o=await k(f.value,e.tableData,s=>{Object.assign(c,{percentage:s*100/a,progressText:`${s}/${a}`})},r,m);if(!e.tabName)e.win&&(e.win.postMessage({type:"update",title:e.name,data:o}),e.win.focus()),y(),e.tableData=o,v(e),m(),O(l.value);else{const s=e.tabName;Reflect.deleteProperty(e,"tabName"),b({tableData:o,name:s})}}function p(){r.isCancel=!0}const C=()=>M.value.checkAll();function m(){C(),r.isCancel=!1,Object.assign(c,{value:!1,percentage:0,showProgress:!1,description:"",progressText:""})}function V(){B.getFiles(async e=>{try{const a=e==null?void 0:e[0];if(!a)return d.error("请选择文件");Object.assign(c,{value:!0,description:"正在读取文件内容"});const o=await a.text(),s=JSON.parse(o||null);if(!s)throw new Error("文件内容为空");const T=s.name;if(l.value.some($=>$.name===T))return d.error(`已经存在 ${T} 窗口`);b(s),d.success("打开文件成功")}catch(a){d.error(String(a))}finally{m()}},".watch")}function S(){if(n.value)return;const e=JSON.stringify(t.value);B.downloadBlob(`${t.value.name}.watch`,new Blob([e]))}return window.getDBItem("cacheWatchTabs").then((e=[])=>{let a=e.find(o=>o.name==="监控主窗口");a?Object.assign(a,E({name:"监控主窗口",isMain:!0})):(a=E({name:"监控主窗口",isMain:!0}),e.push(a)),t.value=a,l.value=e}),{tabs:l,splitSize:h,noSaveAs:n,msgCheckedKeys:f,msgTreeRef:M,fullLoading:c,addToWatch:u,removeTab:N,onTabChange:v,cancelToTable:p,importWatch:V,saveTabAs:S}}function X(t){const{appContext:x}=R(),{$message:y}=x.config.globalProperties,w=D(),{refresh:d}=W(M),l=P(()=>new Map(t.value.tableData.map(n=>[n.parentNames.concat([n.label]).join("-"),n])));function M(n){if(!n||!n.length)return;const h=t.value.tableExtendedData,i=h.displayType,v=h.readValue,c=h.TimeRefresh,f=l.value,r={hex_value:"Hex_Value",binary_value:"Binary_Value",engineering_value:"Engineering_Value"};for(let u=0;u<n.length;u++){const p=n[u];if(!p)continue;const C=f.get(p.Name);if(!C)continue;const m=C.GUID;let V=i[m];V||(V=i[m]="engineering_value");const S=r[V],e=p[S];v[m]=e,c[m]=p.TimeStamp}}let b=null;function N(n,h){const i=h||w.value.getSendCheckboxRecords();if(!i.length)return y.error("请勾选要发送的数据");const v=[];i==null||i.forEach(f=>{const r=t.value.tableExtendedData.writeValue[f.GUID],u=f.DefaultValue;if((r===void 0||r==="")&&(u===void 0||u===""))return;const p={...f,_Value:B.parseValue(r||u)};typeof r=="object"&&Object.assign(p,r),v.push(p)});const c=L(v);n.sendType===1?(g(),b=_({time:Number(n.timer)||1e3,messageList:c}),n.pubValueTimer=1):_({once:!0,messageList:c})}function g(){b==null||b.abort(),t.value.pubValueTimer=null}return{AeTableRef:w,startSendValues:N,setQueryValues:d,stopSendValues:g}}export{Q as a,E as c,X as u};
