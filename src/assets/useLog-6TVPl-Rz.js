import{r as F,bg as N,h as y,bh as P,s as k,j as B,c as f,a as S}from"./index-Dju9e0Mk.js";import{e as V}from"./dataMonitor-BqNmZQKc.js";const L=F(!1),$=t=>{L.value=t};let p=null;function O(t){t=Math.max(0,Math.floor(t));const i=Math.floor(t/3600),a=Math.floor(t%3600/60),u=t%60,g=i.toString().padStart(2,"0"),r=a.toString().padStart(2,"0"),c=u.toString().padStart(2,"0");return`${g}:${r}:${c}`}function W(){const t=N(),i=F(0),a=F(0),u=F("");function g(){p=t.info({title:"正在记录日志...",content:()=>y("div",null,[y("div",`剩余时间：${O(i.value)}`),y(P,{style:{marginTop:"5px"},percentage:a.value,indicatorPlacement:"inside",processing:!0})]),onClose(){p.destroy(),p=null},meta:`日志生成地址：${u.value}`})}function r(){$(!1),p&&(p==null||p.destroy(),p=null),sessionStorage.removeItem("logCountdown")}function c(){u.value=sessionStorage.getItem("log_fullPath"),a.value=0,i.value=Number(sessionStorage.getItem("log_totalTime")),g(),$(!0)}function I(l){const b=Number(sessionStorage.getItem("log_totalTime"));a.value=Number((l/b*100).toFixed(2)),i.value=Math.floor(b-l),a.value>=100&&(r(),t.success({title:"日志记录完成",content:`路径：${u.value}`}))}return{createCountdown:c,countDownClose:r,updateCountdown:I}}let w=null;const j={log_filepath:{required:!0,message:"请选择保存的文件路径"}},A=[{label:"秒",value:"s"},{label:"分钟",value:"m"},{label:"小时",value:"h"}];function R(){const t=new Date,i=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,0),u=String(t.getDate()).padStart(2,0),g=String(t.getHours()).padStart(2,0),r=String(t.getMinutes()).padStart(2,0),c=String(t.getSeconds()).padStart(2,0);return`${i}-${a}-${u}-${g}-${r}-${c}`}function H(t){const{appContext:i}=k(),{$message:a,$modal:u}=i.config.globalProperties,{createCountdown:g,countDownClose:r,updateCountdown:c}=W(),I=F(null);let l=null;function b(){if(L.value)return a.warning("日志正在记录中，请勿重复操作");const o=localStorage.getItem("log_filepath"),e=B({log_filepath:o,iTime:"5",unit:"m"});w=u.open({title:"配置 Log 信息",width:700,okText:"确认",cancelText:"取消",titleAlign:"start",draggable:!0,content:()=>f(S("a-form"),{ref:I,labelPlacement:"left",labelWidth:"auto",rules:j,requireMarkPlacement:"left-hanging",model:e,"auto-label-width":!0},{default:()=>[f(S("a-form-item"),{label:"保存的文件路径（含文件名）",field:"log_filepath"},{default:()=>[f("div",{style:"display:flex;align-items: center;width: 100%"},[f(S("a-input"),{modelValue:e.log_filepath,"onUpdate:modelValue":n=>e.log_filepath=n,placeholder:"请输入保存的文件路径"},null)])]}),f(S("a-form-item"),{label:"时间跨度"},{default:()=>[f("div",{style:"display:flex;align-items: center;width: 100%"},[f(S("a-input"),{modelValue:e.iTime,"onUpdate:modelValue":n=>e.iTime=n,placeholder:"请输入时间跨度"},null),f(S("a-select"),{modelValue:e.unit,"onUpdate:modelValue":n=>e.unit=n,options:A,placeholder:"请选择单位",style:"width: 100px"},null)])]})]}),onBeforeOk:()=>C(e)})}const C=o=>{var e;return(e=I.value)==null||e.validate(n=>{if(!n){const s={...o},{iTime:d,unit:h}=o;let m=d;if(m)try{m={s:v=>+v,m:v=>v*60,h:v=>v*60*60}[h](d)}catch{}const _=`${o.log_filepath}-${R()}.datalog`;Object.assign(s,{duration:m,log_filepath:_}),localStorage.setItem("log_filepath",o.log_filepath),sessionStorage.setItem("log_totalTime",m),sessionStorage.setItem("log_fullPath",_),M(s)}}),!1};function M(o){const e=t.value.getLogCheckboxRecords();if(!(e!=null&&e.length))return a.error("请选择要LOG的数据");l=new Worker("/webWorker/StartLog.js",{name:"StartLog"}),l.onmessage=n=>{try{const s=n.data;if(s.type==="startLog"){const{errMsg:d,id:h,code:m}=s.data;if(m!==200)return a.error(d);w==null||w.close(),sessionStorage.setItem("logId",h),g()}else if(s.type==="logInfo"){const{usedTime:d=0,totalTime:h=0,status:m}=s.data||{};c(s.data.usedTime),(d>=h||!m)&&T()}}catch(s){console.log(s)}},l.postMessage(JSON.stringify({type:"startLog",tabData:e,body:o}))}function T(){l==null||l.terminate(),r==null||r(),sessionStorage.removeItem("logId"),sessionStorage.removeItem("log_totalTime"),sessionStorage.removeItem("log_fullPath")}function x(){const o=sessionStorage.getItem("logId");if(!o)return a.error("没有Log数据");T(),V(Number(o))}function D(){const o=sessionStorage.getItem("logId");o&&(l=new Worker("/webWorker/StartLog.js",{name:"StartLog"}),g(),l.onmessage=e=>{const n=e.data;if(n.type==="logInfo"){const{usedTime:s=0,totalTime:d=0,status:h}=n.data||{};c(n.data.usedTime),(s>=d||!h)&&T()}},l.postMessage(JSON.stringify({type:"logInfo",logId:o})))}return D(),{logLoading:L,startLog:b,stopLog:x}}export{H as u};
